<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.thymeleaf.org ">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/menu.css}"/>
    <title>Realizar Venda</title>
</head>
<body>
    <div th:replace="fragments/menu.html :: menu"></div>


    <div class="pusher">
        <div class="ui segment">
            <form th:action="@{/venda/cadastro/save}"
                  th:object="${venda}"
                  method="post"
                  id="formularioVenda"
                  class="ui form">
                <h2 class="ui dividing header">Realizar Venda</h2>

                <h3 class="ui dividing header">Cliente</h3>
                <div class="fields">
                    <select th:field="*{cliente}">
                        <option th:each="cliente : ${clientes}"
                                th:value="${cliente.id}"
                                th:text="${cliente.nome}">
                        </option>
                    </select>
                    <button type="button" id="btnAddMerc" class="ui primary button">Adicionar Mercadoria</button>
                </div>

                <h3 class="ui dividing header">Sumário da Venda</h3>
                <div class="field">
                    <table class="ui celled table">
                        <thead>
                            <tr>
                                <td class="three wide field">Nome</td>
                                <td class="three wide field">Marca</td>
                                <td class="two wide field">Preço Unitário</td>
                                <td class="two wide field">Quantidade Adicionada</td>
                                <td class="two wide field">Opção</td>
                            </tr>
                        </thead>
                        <tbody id="carrinhoTableBody">
                 
                        </tbody>
                    </table>
                </div>


                <div class="field">
                    <label>Valor Total</label>
                    <input id="vendaValor" type="number" readonly th:field="*{valor}">
                </div>
                
                <button value="submit" class="ui primary button">Realizar Venda</button>
            </form>





            <div class="ui fullscreen modal">
                <form class="ui form"
                      th:object="${venda}">
                    <h3 class="ui dividing header">Mercadorias</h3>
                    <div class="field">
                        <input id="itemEstocadoSearch">
                        <table class="ui celled table scrolling content">
                            <thead>
                                <tr>
                                    <td class="six wide field">Nome</td>
                                    <td class="one wide field">Quantidade Estoque</td>
                                    <td class="one wide field">Preço Venda</td>
                                    <td class="one wide field" colspan="2">Quantidade</td>
                                </tr>
                            </thead>
                            <tbody id="itemEstocadoTableBody">
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>

        </div>
        
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
            var itensEstocados = /*[[${itens_estocados}]]*/;
        /*]]>*/

        console.log("ASD");
        document.getElementById('btnAddMerc').addEventListener('click', function() {
            $('.ui.fullscreen.modal').modal('show');
            makeItemEstocadoTable();
        });

        const itensVenda = {};

        function makeItemEstocadoTable() {
            let table = document.getElementById('itemEstocadoTableBody');
            table.innerHTML = '';
            for(item in itensEstocados) {
                let row = `<tr>
                    <td>${itensEstocados[item].mercadoria.nome}</td>
                    <td>${itensEstocados[item].quantidade}</td>
                    <td>${itensEstocados[item].precoVenda}</td>
                    <td><input id="qtd${itensEstocados[item].id}" /></td>
                    <td><button type="button" onclick="adicionarItemNaVenda(${itensEstocados[item].id})">Adicionar</button></td>
                </tr>`
                table.innerHTML += row;

            }

        }

        function adicionarItemNaVenda(id) {
            let itemEstocado = itensEstocados[`${id}`]
            let quantidade = document.getElementById(`qtd${id}`).value;
            if(quantidade > itemEstocado.quantidade) {
                alert("Quantidade Acima do Estocado");
            } else {
                itensVenda[`${id}`] = {itemEstocado, quantidade};
                console.log(itensVenda);
                makeVendaTable();
                itensEstocados[`${id}`].quantidade -= parseInt(quantidade);
                $('.ui.fullscreen.modal').modal('hide');
            }
        };

        function makeVendaTable() {
            let index = 0;
            let valor = 0;
            let vendaValor = document.getElementById('vendaValor');
            let fieldName = "itensVendidos";
            let carrinhoTableBody = document.getElementById('carrinhoTableBody');
            carrinhoTableBody.innerHTML = '';
            for(item in itensVenda) {
                let row = `<tr>
                    <td>${itensVenda[item].itemEstocado.mercadoria.nome}</td>
                    <td>${itensVenda[item].itemEstocado.mercadoria.marca}</td>
                    <td>${itensVenda[item].itemEstocado.precoVenda}</td>
                    <td>${itensVenda[item].quantidade}</td>
                    <td><button class="negative ui button" type="button">Remover</button></td>
                    <input type="hidden" name="${fieldName}[${index}].itemEstocado" value="${itensVenda[item].itemEstocado.id}"/>
                    <input type="hidden" name="${fieldName}[${index}].quantidade" value="${itensVenda[item].quantidade}"/>
                    <input type="hidden" name="${fieldName}[${index}].precoVenda" value="${itensVenda[item].itemEstocado.precoVenda}"/>
                </tr>`;
                for(var i = 0; i < `${itensVenda[item].quantidade}`; i++) {
                    valor += parseFloat(`${itensVenda[item].itemEstocado.precoVenda}`);
                }
                carrinhoTableBody.innerHTML += row;
                index++;
            }
            vendaValor.value = parseFloat(valor.toFixed(2));
        }

        function removerItem() {

        }
        
    </script>

        

</body>
</html>