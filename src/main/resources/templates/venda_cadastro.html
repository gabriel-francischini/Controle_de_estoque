<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.thymeleaf.org ">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/menu.css}"/>
    <title>Realizar Venda</title>
</head>
<body>
    <div th:replace="fragments/menu.html :: menu"/>


    <div class="pusher">
        <div class="ui segment">
            <form th:action="@{/venda/cadastro/save}"
                  th:object="${venda}"
                  method="post"
                  id="formularioVenda"
                  class="ui form">
                <h2 class="ui dividing header">Realizar Venda</h2>

                <h3 class="ui dividing header">Cliente</h3>
                <div class="field">
                    <select th:field="*{cliente.id}">
                        <option th:each="cliente : ${clientes}"
                                th:value="${cliente.id}"
                                th:text="${cliente.nome}">
                        </option>
                    </select>
                </div>

                <h3 class="ui dividing header">Sumário da Venda</h3>
                <div class="field">
                    <table class="ui celled table">
                        <thead>
                            <tr>
                                <td class="three wide field">Nome</td>
                                <td class="three wide field">Marca</td>
                                <td class="two wide field">Preço Unitário</td>
                                <td class="two wide field">Quantidade Adicionada</td>
                                <td class="two wide field">Opção</td>
                            </tr>
                        </thead>
                        <tbody id="carrinhoTableBody">
                            <tr th:each="item, itemStat: ${venda.itemVendidos}">
                                <input type="hidden" th:field="*{itemVendidos[__${itemStat.index}__].itemEstocado.id}" \>
                                <td th:text="${item.itemEstocado.mercadoria.nome}"></td>
                                <td>I vai</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="ui dividing header">Mercadorias</h3>
                <div class="field">
                    <input id="itemEstocadoSearch">
                    <table class="ui celled table">
                        <thead>
                            <tr>
                                <td class="six wide field">Nome</td>
                                <td class="four wide field">Marca</td>
                                <td class="one wide field">Quantidade Estoque</td>
                                <td class="one wide field">Preço Venda</td>
                                <td class="one wide field">Quantidade</td>
                                <td class="three wide field">Adicionar</td>
                            </tr>
                        </thead>
                        <tbody id="itemEstocadoTableBody">
                        </tbody>
                    </table>

                </div>

                <div class="field">
                    <label>Valor Total</label>
                    <input type="number" th:field="*{valor}">
                </div>



                <button value="submit" class="ui primary button">Realizar Venda</button>
            </form>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>


        <script th:inline="javascript">
        /*<![CDATA[*/
            var itemEstocados = /*[[${itens_estocados}]]*/;

        $('#itemEstocadoSearch').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            console.log('Value = '+ value);
            if(value.length > 2) {
                var data = FilterFunction(value, itemEstocados);
                rebuildTable(data);
            }

        });
        function FilterFunction(value, data) {
            var filteredData = [];
            for(var i = 0; i < data.length; i++) {
                var nome = data[i].mercadoria.nome.toLowerCase();
                var marca = data[i].mercadoria.marca.toLowerCase();
                if(nome.includes(value) || marca.includes(value)) {
                    filteredData.push(data[i]);
                }
            }
            return filteredData;
        }

        function rebuildTable(data) {
            var tableBody = document.getElementById('itemEstocadoTableBody')
            tableBody.innerHTML='';
            for(var i = 0; i < data.length; i++) {
                var row =`<tr>
                    <td>${data[i].mercadoria.nome}</td>
                    <td>${data[i].mercadoria.marca}</td>
                    <td>${data[i].quantidade}</td>
                    <td>${data[i].precoVenda}</td>
                    <td><input type="number" text="0"/></td>
                    <td><a onclick="adicionarItem(${data[i].id})" class="ui blue button">Adicionar</a></td>
                </tr>`;
                tableBody.innerHTML += row;
            }
        }
        function adicionarItem(id) {
            $('#formularioVenda').attr('action', `/venda/cadastro/addItem/${id}`);
            $('#formularioVenda').submit();


            /*
            console.log(itemEstocadoJSON);
            var carrinhoTableBody = document.getElementById('carrinhoTableBody');
            var row =`<tr>
                    <td th:field={}>${nome}</td>
                    <td>${marca}</td>
                    <td>${preco}</td>
                    <td>${quantidade}</td>
                    <td><input type="number"></td>
                    <td><a class="negative ui button">Excluir</a></td>
                </tr>`;
            carrinhoTableBody.innerHTML += row;
            */
        }

        function removerItemCarrinho(item) {
            var carrinhoTableBody = document.getElementById('carrinhoTableBody');
        }

        function atualizarValorTotal() {
        }
        /*]]>*/
        </script>


</body>
</html>